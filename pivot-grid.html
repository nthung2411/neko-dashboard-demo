<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Neko Dashboard 2 Demo</title>

    <link href="./styles/kendo.common.min.css" rel="stylesheet" />
    <link href="./styles/kendo.default.mobile.min.css" rel="stylesheet" />
    <link href="./styles/kendo.default.min.css" rel="stylesheet" />
    <link href="./index.css" rel="stylesheet" />
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jszip.min.js"></script>
    <script src="./js/kendo.all.min.js"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"
      integrity="sha512-LGXaggshOkD/at6PFNcp2V2unf9LzFq6LE+sChH7ceMTDP0g2kn6Vxwgg7wkPP7AAtX+lmPqPdxB47A0Nz0cMQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
    <ul id="menu">
      <li><a href="/">Normal Grid</a></li>
      <li class="k-state-active"><a href="/pivot-grid.html">Pivot Grid</a></li>
    </ul>

    <h1>Pivot Grid</h1>

    <div class="content">
      <div id="configurator" class="hidden-on-narrow"></div>
      <div id="pivotgrid" class="hidden-on-narrow"></div>

      <div class="responsive-message"></div>
    </div>

    <div class="loader">
      <span id="loader"></span>
    </div>
    <script src="./global.js"></script>
    <script>
      $(document).ready(function () {
        const prepareGridData = function (data) {
          if (!Array.isArray(data)) {
            return;
          }
          const scholars = data;
          const gridData = [];
          for (let i = 0; i < scholars.length; i++) {
            const scholar = scholars[i];
            const dailySLPs = scholar["_dailySLP"];
            if (!Array.isArray(dailySLPs)) {
              continue;
            }
            gridData.push(...dailySLPs);
          }
          gridData.forEach(function (item) {
            item.scholarName = item["scholar"]["name"];
            const date = moment(item.date).format("DD MMM yyyy");
            item.date = date;
          });
          return gridData;
        };

        const onGetScholarsSuccess = function (result) {
          if (!result.ok) {
            onGetScholarsFail(result);
            return;
          }
          const pivotData = prepareGridData(result.data);

          const pivotDataSource = new kendo.data.PivotDataSource({
            columns: ["customerId", "date"],
            rows: ["scholarName"],
            measures: ["Sum"],
            data: pivotData,
            schema: {
              cube: {
                dimensions: {
                  scholarName: { caption: "All Scholars" },
                  customerId: { caption: "All Customer IDs" },
                  date: { caption: "All days" },
                },
                measures: {
                  Sum: {
                    field: "amount",
                    format: "{0:d}",
                    aggregate: function (value, state, context) {
                      return (state.accumulator || 0) + value;
                    },
                  },
                },
              },
            },
          });

          const pivotgrid = $("#pivotgrid")
            .kendoPivotGrid({
              filterable: true,
              sortable: true,
              columnWidth: 200,
              height: 720,
              dataSource: pivotDataSource,
            })
            .data("kendoPivotGrid");

          $("#configurator").kendoPivotConfigurator({
            dataSource: pivotgrid.dataSource,
            filterable: true,
            sortable: true,
            height: 720,
          });
        };

        const onGetScholarsFail = function (data) {
          console.error(error);
        };

        $.getJSON("./env.json", function (result) {
          let url = result.useMockData
            ? "./mock/scholars.json"
            : "http://34.124.189.18:8001/v1/scholars";
          $.ajax({
            url,
            success: onGetScholarsSuccess,
            error: onGetScholarsFail,
          });
        });
      });
    </script>
    <style>
      #configurator {
        width: 400px;
        min-width: 400px;
        display: inline-block;
        vertical-align: top;
      }

      #pivotgrid {
        width: 67%;
        display: inline-block;
        vertical-align: top;
      }
    </style>
  </body>
</html>
