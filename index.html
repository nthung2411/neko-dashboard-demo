<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Neko Dashboard 2 Demo</title>

    <link href="./styles/kendo.common.min.css" rel="stylesheet" />
    <link href="./styles/kendo.default.min.css" rel="stylesheet" />
    <link href="./styles/index.css" rel="stylesheet" />
    <script src="./scripts/jquery.min.js"></script>
    <script src="./scripts/jszip.min.js"></script>
    <script src="./scripts/kendo.all.min.js"></script>
  </head>

  <body>
    <div id="loader"></div>
    <div id="ordersGrid"></div>

    <script>
      $(function () {
        const $loading = $("#loader").hide(); // Hide it initially
        $(document)
          .ajaxStart(function () {
            $loading.show();
          })
          .ajaxStop(function () {
            $loading.hide();
          });

        const bindDataToGrid = function (gridData) {
          var gridDataSource = new kendo.data.DataSource({
            data: gridData,
            // schema: {
            //     model: {
            //         fields: {
            //             scholarId: { type: "number" },
            //             scholarName: { type: "string" },
            //             customerId: { type: "number" },
            //             amount: { type: "number" },
            //             date: { type: "date" }
            //         }
            //     }
            // },
            pageSize: 10,
            sort: {
              field: "date",
              dir: "desc",
            },
          });

          $("#ordersGrid").kendoGrid({
            dataSource: gridDataSource,
            // height: 400,
            pageable: true,
            sortable: true,
            filterable: true,
            columns: [
              {
                field: "scholarId",
                title: "Scholar ID",
                width: 160,
              },
              {
                field: "scholarName",
                title: "Scholar Name",
                width: 160,
              },
              {
                field: "customerId",
                title: "Customer Id",
                width: 160,
              },
              {
                field: "amount",
                title: "Amount",
              },
              {
                field: "date",
                title: "Date",
                width: 200,
                format: "{0:dd MMMM yyyy}",
              },
            ],
            toolbar: ["search", "excel"],
            excel: {
              fileName: "Kendo UI Grid Export.xlsx",
            },
            search: {
              fields: [
                { name: "scholarId", operator: "eq" },
                { name: "customerId", operator: "eq" },
                { name: "amount", operator: "gte" },
                { name: "scholarName", operator: "contains" },
              ],
            },
            groupable: true,
          });
        };
        
        const prepareGridData = function (data) {
          if (!Array.isArray(result.data)) {
            return;
          }
          const scholars = result.data;
          const gridData = [];
          for (let i = 0; i < scholars.length; i++) {
            const scholar = scholars[i];
            const dailySLPs = scholar["_dailySLP"];
            if (!Array.isArray(dailySLPs)) {
              continue;
            }
            gridData.push(...dailySLPs);
          }
          return gridData;
        };

        const onGetScholarsSuccess = function (result) {
          if (!result.ok) {
            return;
          }
          const gridData = prepareGridData(result.data);
          console.log(gridData);
          bindDataToGrid(gridData);
        };

        $.ajax({
          url: "http://34.124.189.18:8001/v1/scholars",
          success: onGetScholarsSuccess,
        });
      });
    </script>
  </body>
</html>
